function LimpiarForm_CobroDeuda(){$("#ddlTipoOperacion")[0].selectedIndex=0,$("#ddlTipoOperacion").trigger("change"),$("#ddlBanco")[0].selectedIndex=0,$("#txtNroCuentaBancaria").val(""),$("#txtNroOperacion").val(""),$("#txtFechaPago").val(moment().format("DD/MM/YYYY")),$("#txtImportePago").val("0.00"),$("#txtImporteMora").val("0.00")}function showTabTipoCliente(e,t,a){$("#pnlForm .mdl-layout-title .text").text(a),$("#hdTipoCliente").val(e),$("#pnlForm section").addClass("hide"),$(t).removeClass("hide"),setDefaultFocus()}function BuscarDatos(e){var t="*#gvDatos",a=t+" .gridview-content";precargaExp("#pnlListado",!0),$.ajax({type:"GET",url:"services/clientes/clientes-search.php",cache:!1,dataType:"json",data:{criterio:$("#txtSearch").val(),idempresa:$("#hdIdEmpresa").val(),idcentro:$("#hdIdCentro").val(),pagina:e},success:function(i){var o=0,n="",r=(getParameterByName("screenmode"),i.length);if(r>0){for(;o<r;){var l=i[o].tm_idtipocliente,d=i[o].tm_foto.replace("_o","_s42");n+='<li class="collection-item avatar no-border dato" data-idmodel="'+l+'"  data-baselement="'+t+'">',n+='<input name="chkItem[]" type="checkbox" class="oculto" value="'+l+'" />',n+='<i class="icon-select material-icons circle white-text">done</i><div class="layer-select"></div>',n+="no-set"==d?'<i class="material-icons circle">&#xE853;</i>':'<img src="'+d+'" alt="" class="circle">',n+='<span class="title descripcion">'+i[o].Descripcion+"</span>",n+="<p>Tel&eacute;fono: "+i[o].tm_telefono+' - Direcci&oacute;n: <span class="direccion">'+i[o].tm_direccion+"</span><br>",n+='<span class="docidentidad">'+i[o].TipoDoc+": "+i[o].tm_numerodoc+"</span> - "+i[o].tm_email+"</p>",n+='<div class="grouped-buttons place-top-right padding5">',n+='<a class="padding5 mdl-button mdl-button--icon tooltipped" href="#" data-action="more" data-delay="50" data-position="bottom" data-tooltip="M&aacute;s"><i class="material-icons md-18">&#xE5D4;</i></a>',n+='<ul class="dropdown"><li><a href="#" data-action="edit" class="waves-effect">Editar</a></li><li><a href="#" data-action="lineacredito" class="waves-effect">L&iacute;nea de cr&eacute;dito</a></li><li><a href="#" data-action="delete" class="waves-effect">Eliminar</a></li></ul>',n+="</div>",n+='<div class="divider"></div>',n+="</li>",++o}datagrid.currentPage(datagrid.currentPage()+1),"1"==e?$(a).html(n):$(a).append("beforeend",n)}else"1"==e&&$(a).html("<h2>No hay datos.</h2>");precargaExp("#pnlListado",!1)},error:function(e){console.log(e)}})}function SeleccinoarCliente(){var e=$("#gvDatos .dato.selected"),t=e[0].getAttribute("data-idcliente"),a=e.find(".descripcion").text();window.parent.setCliente(t,a)}function LimpiarForm(){$("#hdIdPrimary").val("0"),$("#hdCodigoOri").val("0"),$("#ddlTipoDocJuridica")[0].selectedIndex=0,$("#txtRucEmpresa").val(""),$("#txtRazonSocial").val(""),$("#txtDireccionEmpresa").val(""),$("#txtTelefonoEmpresa").val(""),$("#txtEmailEmpresa").val(""),$("#txtWebEmpresa").val(""),$("#ddlTipoDocNatural")[0].selectedIndex=0,$("#txtNroDocNatural").val(""),$("#txtApePaterno").val(""),$("#txtApeMaterno").val(""),$("#txtNombres").val(""),$("#txtDireccionNatural").val(""),$("#txtTelefonoNatural").val(""),$("#txtEmailNatural").val("")}function GuardarDatos(){var e=document.getElementById("hdFoto"),t=fileValue,a=new FormData;precargaExp("#pnlForm",!0),"images/user-nosetimg-233.jpg"==e.value&&(e.value="no-set"),a.append("btnGuardar","btnGuardar"),a.append("hdIdEmpresa",$("#hdIdEmpresa").val()),a.append("hdIdCentro",$("#hdIdCentro").val()),a.append("archivo",t);var i=$("#pnlForm :input").serializeArray();Array.prototype.forEach.call(i,function(e){a.append(e.name,e.value)}),$.ajax({type:"POST",url:"services/clientes/clientes-post.php",contentType:!1,processData:!1,cache:!1,dataType:"json",data:a,success:function(e){precargaExp("#pnlForm",!1),createSnackbar(e.titulomsje),"0"!=e.rpta&&(closeCustomModal("#pnlForm"),paginaGeneral=1,BuscarDatos("1"))},error:function(e){console.log(e)}})}function setDefaultFocus(){}function GoToEdit(e){var t="JU",a="#tabJuridico",i="Cliente jurídico",o="#pnlForm";document.getElementById("hdIdPrimary").value="0",document.getElementById("hdFoto").value="no-set",precargaExp(o,!0),resetFoto("new"),LimpiarForm(),openModalCallBack(o,function(){"0"==e?(precargaExp(o,!1),showTabTipoCliente(t,a,i),habilitarLink("#btnTipoCliente",!0)):$.ajax({url:"services/clientes/clientes-search.php",type:"GET",dataType:"json",cache:!1,dataType:"json",data:{tipobusqueda:"2",id:e},success:function(e){if(e.length>0){var n=e[0].tm_foto,r=n.replace("_o","_s255");t=e[0].tm_iditc,a="NA"==t?"#tabNatural":"#tabJuridico",i="NA"==t?"Cliente natural":"Cliente jurídico",$("#hdIdPrimary").val(e[0].tm_idtipocliente),$("#hdCodigoOri").val(e[0].tm_codigo_ori),$("#hdTipoCliente").val(e[0].tm_iditc),showTabTipoCliente(t,a,i),"NA"==t?($("#ddlTipoDocNatural").val(e[0].tm_iddocident).trigger("change"),$("#txtNroDocNatural").val(e[0].tm_numerodoc),$("#txtDireccionNatural").val(e[0].tm_direccion),$("#txtTelefonoNatural").val(e[0].tm_telefono),$("#txtApePaterno").val(e[0].tm_apepaterno),$("#txtApeMaterno").val(e[0].tm_apematerno),$("#txtNombres").val(e[0].tm_nombres),$("#txtEmailNatural").val(e[0].tm_email),$("#ddlPaisNatural").changeMaterialSelect(e[0].tp_idpais),ListarUbicacion("#ddlRegionNatural",e[0].tp_idpais,e[0].tm_idciudad)):($("#ddlTipoDocJuridica").val(e[0].tm_iddocident).trigger("change"),$("#txtRucEmpresa").val(e[0].tm_numerodoc),$("#txtRazonSocial").val(e[0].tm_razsocial),$("#txtEmailEmpresa").val(e[0].tm_email),$("#txtRepresentante").val(e[0].tm_representante),$("#txtDireccionEmpresa").val(e[0].tm_direccion),$("#txtTelefonoEmpresa").val(e[0].tm_telefono),$("#txtWebEmpresa").val(e[0].tm_urlweb),$("#ddlPaisEmpresa").changeMaterialSelect(e[0].tp_idpais),ListarUbicacion("#ddlRegionEmpresa",e[0].tp_idpais,e[0].tm_idciudad)),"no-set"!=n?setFoto(r):r="images/user-nosetimg-233.jpg",imgFoto.setAttribute("data-src",r),hdFoto.value=n,Materialize.updateTextFields()}habilitarLink("#btnTipoCliente",!1),precargaExp(o,!1)},error:function(e){console.log(e)}})})}function EliminarCliente(){indexList=0,elemsSelected=$("#gvDatos .selected"),EliminarItemCliente(elemsSelected[0],"multiple")}function EliminarItemCliente(e,t){var a=new FormData,i=e.getAttribute("data-idmodel");a.append("btnEliminar","btnEliminar"),a.append("hdIdCliente",i),$.ajax({url:"services/clientes/clientes-post.php",type:"POST",dataType:"json",data:a,cache:!1,contentType:!1,processData:!1,success:function(a){var i,o,n=0,r="",l=0;o=$(e),l=o.height(),"0"==a.rpta?(endqueue=!0,r="No se puede eliminar"):(o.fadeOut(400,function(){$(this).remove()}),"multiple"==t?(++indexList,i=$("#gvDatos .gridview"),n=i.scrollTop(),indexList<=elemsSelected.length-1?(n+=l+18,i.animate({scrollTop:n},400,function(){EliminarItemCliente(elemsSelected[indexList],t)})):(endqueue=!0,r=a.titulomsje)):"single"==t&&(endqueue=!0,r=a.titulomsje)),endqueue&&(createSnackbar(r),$(".actionbar").hasClass("is-visible")&&$(".back-button").trigger("click"))},error:function(e){console.log(e)}})}function ListarLineaCredito(e){$.ajax({type:"GET",url:"services/lineacredito/lineacredito-search.php",cache:!1,dataType:"json",data:{tipobusqueda:"1",id:$("#hdIdCliente").val()},success:function(e){var t=0,a=e.length,i="";if(a>0){for(;t<a;)i+='<tr data-idlineacredito="'+e[t].td_idlineacredito+'">',i+='<td class="align-center">'+(t+1)+"</td>",i+='<td class="align-center">'+ConvertMySQLDate(e[t].FechaReg)+"</td>",i+='<td class="align-right">'+Number(e[t].importelinea).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].consumo).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].cancelado).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].saldo).toFixed(2)+"</td>",i+='<td class="align-center no-padding"><button class="mdl-button mdl-button--colored tooltipped margin5" type="button" data-action="deudas" data-delay="50" data-position="bottom" data-tooltip="DEUDAS">DEUDAS</button></td>',i+='<td class="align-center no-padding"><button class="mdl-button mdl-button--colored tooltipped margin5" type="button" data-action="cobros" data-delay="50" data-position="bottom" data-tooltip="COBROS">COBROS</button></td>',i+="</tr>",++t;$("#tableLineaCredito .empty_state").addClass("hide"),$("#tableLineaCredito .table-responsive-vertical").removeClass("hide")}else $("#tableLineaCredito .empty_state").removeClass("hide"),$("#tableLineaCredito .table-responsive-vertical, #btnCobroDeuda").addClass("hide");$("#tableLineaCredito tbody").html(i)},error:function(e){console.log(e)}})}function CobrarDeuda(){var e=new FormData,t=$("#pnlCobroDeuda :input").serializeArray();e.append("btnCobrarDeuda","btnCobrarDeuda"),Array.prototype.forEach.call(t,function(t){e.append(t.name,t.value)}),$.ajax({url:"services/lineacredito/lineacredito-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){createSnackbar(e.titulomsje),"0"!=e.rpta&&(closeCustomModal("#pnlCobroDeuda"),ListarDeudaCobrar(idlineacredito),ListarLineaCredito("1"))},error:function(e){console.log(e)}})}function GuardarLineaCredito(){var e=new FormData,t=$("#pnlFormLineaCredito :input").serializeArray();e.append("btnAplicarLineaCredito","btnAplicarLineaCredito"),e.append("hdIdCliente",$("#hdIdCliente").val()),Array.prototype.forEach.call(t,function(t){e.append(t.name,t.value)}),$.ajax({url:"services/lineacredito/lineacredito-post.php",type:"POST",dataType:"json",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){createSnackbar(e.titulomsje),"0"!=e.rpta&&(closeCustomModal("#pnlFormLineaCredito"),ListarLineaCredito("1"))},error:function(e){console.log(e)}})}function ListarDeudaCobrar(e){$.ajax({type:"GET",url:"services/lineacredito/deudacobrar-search.php",cache:!1,dataType:"json",data:{tipobusqueda:"1",id:e},success:function(e){var t=0,a=e.length,i="";if(a>0){for(;t<a;)i+='<tr data-iddeuddacobrar="'+e[t].td_iddeudacobrar+'">',i+='<td class="align-center">'+(t+1)+"</td>",i+='<td class="align-center">'+ConvertMySQLDate(e[t].td_fechagen)+"</td>",i+='<td class="align-center">'+ConvertMySQLDate(e[t].td_fechainipago)+"</td>",i+='<td class="align-center">'+ConvertMySQLDate(e[t].td_fechafinpago)+"</td>",i+='<td class="align-right">'+Number(e[t].td_valormora).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].td_importe).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].td_importecancelado).toFixed(2)+"</td>",i+='<td class="align-right">'+Number(e[t].saldo).toFixed(2)+"</td>",i+='<td class="align-center">'+e[t].EstadoDeuda+"</td>",i+='<td class="align-center no-padding"><button class="mdl-button mdl-button--colored tooltipped margin5" type="button" data-action="pay" data-delay="50" data-position="bottom" data-tooltip="Cobrar deuda">Cobrar deuda</button></td>',i+="</tr>",++t;$("#tableLineaDetalleCredito .empty_state").addClass("hide"),$("#tableLineaDetalleCredito .table-responsive-vertical").removeClass("hide")}else $("#tableLineaDetalleCredito .empty_state").removeClass("hide"),$("#tableLineaDetalleCredito .table-responsive-vertical").addClass("hide");$("#tableLineaDetalleCredito tbody").html(i)},error:function(e){console.log(e)}})}function Buscar(){BuscarDatos("1")}function showAll(){$("#txtSearch").val(""),Buscar()}$(function(){BuscarDatos("1"),$("#ddlTipoOperacion").on("change",function(e){e.preventDefault(),"01"==$(this).val()?$(".rowOperacion").addClass("hide"):$(".rowOperacion").removeClass("hide")}),$("#txtImporteLinea").on("focus",function(e){e.preventDefault(),this.select()}),$("#tableLineaCredito").on("click",'button[data-action="deudas"]',function(e){e.preventDefault();var t=getParentsUntil(this,"#tableLineaCredito","tr");t=t[0],openModalCallBack("#pnlDetalleLineaCredito",function(){idlineacredito=t.getAttribute("data-idlineacredito"),ListarDeudaCobrar(idlineacredito)})}),$("#tableLineaDetalleCredito").on("click",'button[data-action="pay"]',function(e){e.preventDefault();var t=getParentsUntil(this,"#tableLineaDetalleCredito","tr");t=t[0];var a=t.getAttribute("data-iddeuddacobrar");$("#hdIdDeudaCobrar").val(a),LimpiarForm_CobroDeuda(),openModalCallBack("#pnlCobroDeuda",function(){})}),$("#ddlPaisNatural").on("change",function(e){e.preventDefault(),ListarUbicacion("#ddlRegionNatural",this.value,"0")}),$("#ddlPaisEmpresa").on("change",function(e){e.preventDefault(),ListarUbicacion("#ddlRegionEmpresa",this.value,"0")}),$(".date-register").datetimepicker({format:"DD/MM/YYYY"}),$("#btnCobroDeuda").on("click",function(e){e.preventDefault(),openModalCallBack("#pnlCobroDeuda",function(){})}),$("#btnCobrarDeuda").on("click",function(e){e.preventDefault(),CobrarDeuda()}),$("#btnGenerarLineaCredito").on("click",function(e){e.preventDefault(),openModalCallBack("#pnlFormLineaCredito",function(){})}),$("#btnAplicarLineaCredito").on("click",function(e){e.preventDefault(),GuardarLineaCredito()}),$("#btnSearch").on("click",function(e){e.preventDefault(),datagrid.showAppBar(!0,"search"),$("#txtSearch").focus()}),$(".back-button").on("click",function(){$("#btnUnSelectAll").trigger("click")}),$("#generic-actionbar").on("click touchend","button",function(e){e.preventDefault();var t=this.getAttribute("data-action");"delete"==t&&MessageBox({content:"¿Desea eliminar todo lo seleccionado?",width:"320px",height:"130px",buttons:[{primary:!0,content:"Eliminar",onClickButton:function(e){EliminarCliente()}}],cancelButton:!0})}),$("#gvDatos").on("click touchend",".dropdown a",function(e){e.preventDefault();var t=this.getAttribute("data-action"),a=getParentsUntil(this,"#gvDatos",".dato"),i=a[0].getAttribute("data-idmodel"),o=a[0].getElementsByClassName("descripcion")[0].innerHTML+" con "+a[0].getElementsByClassName("docidentidad")[0].innerHTML;console.log(o),"edit"==t?GoToEdit(i):"lineacredito"==t?($("#hdIdCliente").val(i),$("#lblCliente").text(o),openModalCallBack("#pnlLineaCredito",function(){ListarLineaCredito("1")})):"delete"==t&&MessageBox({content:"¿Desea eliminar este elemento?",width:"320px",height:"130px",buttons:[{primary:!0,content:"Eliminar",onClickButton:function(e){EliminarItemCliente(a[0],"single")}}],cancelButton:!0})}),$("#btnNuevo").on("click",function(e){e.preventDefault(),GoToEdit("0")}),$("#btnTipoCliente").on("click",function(e){e.preventDefault(),e.stopPropagation(),$("#btnTipoCliente").hasClass("disabled")||$("#mnuTipoCliente").addClass("is-visible")}),$("#btnGuardar").on("click",function(e){GuardarDatos()})});var indexList=0,elemsSelected,progress=0,progressError=!1,progressSuccess=!1,datagrid=new DataList("#gvDatos",{onSearch:function(){BuscarDatos(datagrid.currentPage())}}),idlineacredito=0;