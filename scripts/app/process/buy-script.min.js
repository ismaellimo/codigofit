function mostrarAlmacen(e){e?$("#gpAlmacen").removeClass("oculto"):$("#gpAlmacen").addClass("oculto")}function LimpiarTarjeta(){$("#ddlNombreTarjeta")[0].selectedIndex=0,ExtraerComisionTarjeta(),$("#txtCodigoRecibo").val(""),Materialize.updateTextFields()}function AlternarBusquedaItems(){$("#rogers-panel").hasClass("is-active")||ListarInsumos("1")}function LimpiarInfoProveedor(){$(".pnlInfoProveedor .descripcion").text("Elegir proveedor..."),$(".pnlInfoProveedor .docidentidad").text(""),$(".pnlInfoProveedor .direccion").text("")}function LimpiarFormProveedor(){$("#txtRazonSocial").val(""),$("#txtRucEmpresa").val(""),$("#txtDireccionJur").val("")}function Limpiar(){$("#txtFecha").val(GetToday()),$("#ddlTipoComprobante")[0].selectedIndex=0,$("#ddlMoneda")[0].selectedIndex=0,$("#ddlFormaPago")[0].selectedIndex=0,$("#txtSerieComprobante").val(""),$("#txtNroComprobante").val(""),ExtraerSimboloMoneda(),ExtraerTipoCambio(),LimpiarTarjeta(),LimpiarInfoProveedor(),$("#tableDetalle tbody tr").remove(),cuentafila=0,CalcularTotal()}function LimpiarInputProducto(){$("#ddlUnidadMedida")[0].selectedIndex=0,$("#txtCantidad").val(""),$("#txtPrecioRef").val("")}function CalcularTotal(){var e=$("#tableDetalle tbody tr"),t=$("#ddlTipoComprobante option:selected").attr("data-codigosunat"),a=e.length,o=0,n=0,i=.18;if(a>0)for(;o<a;)n+=Number(e[o].getElementsByClassName("subtotal")[0].getElementsByTagName("input")[0].value),++o;var r=n,l=0;$("#chkImpuesto")[0].checked&&(r="01"==t?n/(1+i):n,l="01"==t?n*i:0),$("#lblTotalSinImpuesto .monto").text(r.toFixed(2)),$("#lblTotalImpuesto .monto").text(l.toFixed(2)),$("#lblTotalConImpuesto .monto").text(n.toFixed(2)),$("#hdTotalSinImpuesto").val(r.toFixed(2)),$("#hdTotalImpuesto").val(l.toFixed(2)),$("#hdTotalConImpuesto").val(n.toFixed(2))}function Guardar(){var e=new FormData,t=$("#pnlForm :input").serializeArray(),a=$("#pnlProveedor :input").serializeArray();e.append("btnGuardar","btnGuardar"),e.append("hdIdAperturaCaja",$("#hdIdAperturaCaja").val()),Array.prototype.forEach.call(t,function(t){e.append(t.name,t.value)}),Array.prototype.forEach.call(a,function(t){e.append(t.name,t.value)}),$.ajax({type:"POST",url:"services/compras/compras-post.php",cache:!1,contentType:!1,processData:!1,dataType:"json",data:e,success:function(e){createSnackbar(e.titulomsje),"0"!=e.rpta&&(BackToList(),BuscarDatos("1"))},error:function(e){console.log(e)}})}function createItem_DetalleCompra(e,t,a,o,n,i,r,l,d,c,s){var u="";return u+="<tr>",u+="<td>"+(cuentafila+1)+"</td>",u+='<td data-title="Descripci&oacute;n" class="v-align-middle">',u+='<input name="mc_itemcompra['+cuentafila+'][iddetalle]" type="hidden" id="iddetalle'+cuentafila+'" value="'+e+'" /><input name="mc_itemcompra['+cuentafila+'][idproducto]" type="hidden" id="idproducto'+cuentafila+'" value="'+t+'" /><input name="mc_itemcompra['+cuentafila+'][descripcion]" type="hidden" id="descripcion'+cuentafila+'" value="'+a+'" /><input name="mc_itemcompra['+cuentafila+'][codtipoproducto]" type="hidden" id="codtipoproducto'+cuentafila+'" value="'+s+'" /><input name="mc_itemcompra['+cuentafila+'][medidapre]" type="hidden" id="medidapre'+cuentafila+'" value="'+r+'" />',u+=a,u+="</td>",u+='<td data-title="Presentaci&oacute;n - UM" class="v-align-middle">'+i+'<input name="mc_itemcompra['+cuentafila+'][idpresentacion]" type="hidden" id="idpresentacion'+cuentafila+'" value="'+o+'" /><input name="mc_itemcompra['+cuentafila+'][idunidadmedida]" type="hidden" id="idunidadmedida'+cuentafila+'" value="'+n+'" /></td>',u+='<td data-title="Cantidad">',u+='<div class="mdl-input-js mdl-textfield mdl-js-textfield full-size no-padding"><input class="mdl-textfield__input no-margin align-right cantidad" type="number" step="any" name="mc_itemcompra['+cuentafila+'][cantidad]" id="cantidad_compra'+cuentafila+'" value="'+l+'"><label class="mdl-textfield__label" for="cantidad_compra'+cuentafila+'"></label></div>',u+="</td>",u+='<td data-title="Precio">',u+='<div class="mdl-input-js mdl-textfield mdl-js-textfield full-size no-padding"><input class="mdl-textfield__input no-margin align-right precio" type="number" step="any" name="mc_itemcompra['+cuentafila+'][precio]" id="precio_compra'+cuentafila+'" value="'+d+'"><label class="mdl-textfield__label" for="precio_compra'+cuentafila+'"></label></div>',u+="</td>",u+='<td data-title="SubTotal" class="subtotal"><input type="hidden" name="mc_itemcompra['+cuentafila+'][subtotal]" id="subtotal_compra'+cuentafila+'" value="'+c+'"><h4 class="grey-text text-right">'+c+"</h4></td>",u+='<td><a class="padding5 mdl-button mdl-button--icon tooltipped center-block" href="#" data-action="delete" data-delay="50" data-position="bottom" data-tooltip="Eliminar"><i class="material-icons">&#xE872;</i></a></td>',u+="</tr>"}function LimpiarPreSeleccion_compra(){$("#starks-panel").hasClass("is-active")?($("#gvInsumo input:checkbox").prop("checked",!1),$("#gvInsumo .precio").val(""),$("#gvInsumo .cantidad").val(""),$("#gvInsumo .subtotal input:hidden").val(""),$("#gvInsumo .subtotal h4").text("0.00").addClass("grey-text")):($("#descripcion_custom0").val(""),$("#cantidad_custom0").val(""),$("#precio_custom0").val(""),$("#subtotal_custom0").val("")),habilitarControl("#btnAddItemsCompra",!1)}function AgregarItemsCompra(){var e,t="",a=0,o=0,n=0,i="",r=0,l=0,d=0,c=0,s=0,u=0;if($("#rogers-panel").hasClass("is-active")){i=$("#descripcion_custom0").val(),s=Number($("#cantidad_custom0").val()),c=Number($("#precio_custom0").val()),u=Number($("#subtotal_custom0").val());var t=createItem_DetalleCompra("0",n,i,r,l,"",d,c,s,u,"02");++cuentafila}else{e=$("#gvInsumo input:checkbox:checked"),a=e.length;var m=$("#tabAddItemsCompra .mdl-tabs__tab:first-child").hasClass("is-active")?"00":"01";if(a>0)for(;o<a;)_row=getParentsUntil(e[o],"#gvInsumo","tr"),_selectPresentacion=_row[0].getElementsByClassName("select-presentacion")[0],r=_selectPresentacion.value,l=_selectPresentacion.options[_selectPresentacion.selectedIndex].getAttribute("data-idunidadmedida"),d=_selectPresentacion.options[_selectPresentacion.selectedIndex].getAttribute("data-medidapre"),presentacion_unidadmedida=_selectPresentacion.options[_selectPresentacion.selectedIndex].text,n=e[o].value,i=_row[0].getElementsByClassName("descripcion")[0].innerHTML,c=_row[0].getElementsByClassName("cantidad")[0].value,s=_row[0].getElementsByClassName("precio")[0].value,u=_row[0].getElementsByClassName("subtotal")[0].getElementsByTagName("input")[0].value,t+=createItem_DetalleCompra("0",n,i,r,l,presentacion_unidadmedida,d,c,s,u,m),++cuentafila,++o}$("#tableDetalle tbody").append(t),CalcularTotal(),LimpiarPreSeleccion_compra(),createSnackbar("Agregado correctamente")}function setProveedor(e,t,a){$("#hdIdProveedor").val(e),$(".pnlInfoProveedor").attr("data-idproveedor",e),$(".pnlInfoProveedor .docidentidad").text(t),$(".pnlInfoProveedor .descripcion").text(a)}function seleccionarProveedor(){var e="0",t="",a="";if($("#rbObtenerProveedor")[0].checked){var o=$("#txtSearchProveedor").val();e=$("#hdIdProveedor").val(),t=o.split("-")[0],a=o.split("-")[1]}else t=$("#txtNroDocProveedor").val(),a=$("#txtRazonSocialProveedor").val();setProveedor(e,t,a),closeCustomModal("#pnlProveedor")}function BackToList(){$("#pnlForm").fadeOut(500,function(){$("#pnlListado").fadeIn(500,function(){})})}function BackToForm(){$("#pnlProductos").fadeOut(500,function(){$("#pnlForm").fadeIn(500,function(){})})}function ExtraerTipoCambio(){var e=$("#ddlMoneda option:selected").attr("data-tipocambio");$("#txtTipoCambio").val(e)}function ExtraerSimboloMoneda(){var e=$("#ddlMoneda option:selected").attr("data-simbolo");$("#lblMonedaCobro").text(e)}function ExtraerComisionTarjeta(){var e=$("#ddlNombreTarjeta option:selected").attr("data-comision");$("#txtComisionTarjeta").val(e)}function GoToEdit(e){$("#pnlListado").fadeOut(500,function(){$("#pnlForm").fadeIn(500,function(){"0"!=e&&$.ajax({type:"GET",url:"services/compras/compras-search.php",cache:!1,data:{tipobusqueda:"3",id:e},dataType:"json",success:function(e){},error:function(e){console.log(e)}})})})}function ListarInsumos(e){var t="";t=$("#tabAddItemsCompra .mdl-tabs__tab:first-child").hasClass("is-active")?"1":"2",$.ajax({url:"services/insumos/insumos-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"INSUMO-PRESENTACION",tipo:t,idempresa:$("#hdIdEmpresa").val(),idcentro:$("#hdIdCentro").val(),idcategoria:$("#hdIdCategoria").val(),idsubcategoria:"0",criterio:$("#txtSearchProd").val(),pagina:e},success:function(t){var a=0,o="",n="#gvInsumo tbody",i=_.groupBy(t,function(e){return e.idarticulo+"#"+e.nombre+"#"+e.tipoinsumo}),r=_.map(i,function(e){return{idarticulo:e[0].idarticulo,nombre:e[0].nombre,tipoinsumo:e[0].tipoinsumo,list_presentacion:e}}),l=r.length;if(l>0){for(;a<l;){var d=0,c=r[a].list_presentacion,s=0;if(c.length>0&&(s=0==c[0].Presentacion.length?0:c.length),o+="<tr>",o+="<td>",s>0&&(o+='<input type="checkbox" class="filled-in" id="chkInsumo'+a+'" value="'+r[a].idarticulo+'" /><label for="chkInsumo'+a+'"></label>'),o+="</td>",o+='<td data-title="Insumo/Articulo" class="descripcion">'+r[a].nombre+"</td>",o+='<td data-title="Presentacion"><select disabled class="select-presentacion browser-default">',s>0)for(;d<s;)"undefined"!=typeof c[d]&&(o+='<option value="'+c[d].idpresentacion+'" data-idunidadmedida="'+c[d].idunidadmedida+'" data-medidapre="'+c[d].medida_presentacion+'">'+c[d].Presentacion+(0==c[d].Presentacion.length?"":" - ")+c[d].UM+"</option>"),++d;else o+='<option value="0" data-idunidadmedida="0">No hay presentaciones</option>';o+="</select></td>",o+='<td data-title="Cantidad">',o+='<div class="mdl-input-js mdl-textfield mdl-js-textfield full-size no-padding"><input disabled class="mdl-textfield__input align-right cantidad" type="number" step="any" id="cantidad'+a+'" value=""><label class="mdl-textfield__label" for="cantidad'+a+'"></label></div>',o+="</td>",o+='<td data-title="Precio">',o+='<div class="mdl-input-js mdl-textfield mdl-js-textfield full-size no-padding"><input disabled class="mdl-textfield__input align-right precio" type="number" step="any" id="precio'+a+'" value=""><label class="mdl-textfield__label" for="precio'+a+'"></label></div>',o+="</td>",o+='<td data-title="SubTotal" class="subtotal">',o+='<input type="hidden" id="subtotal'+a+'" value="0"><h4 class="grey-text text-right">0.00</h4>',o+="</td>",o+="</tr>",++a}gvInsumo.currentPage(gvInsumo.currentPage()+1),"1"==e?$(n).html(o):$(n).append(o)}else"1"==e&&$(n).html(""),habilitarControl("#btnAddItemsCompra",!1)},error:function(e){console.log(e)}})}function BuscarDatos(e){var t="#gvDatos";precargaExp("#pnlListado",!0),$.ajax({url:"services/compras/compras-search.php",type:"GET",cache:!1,dataType:"json",data:{tipobusqueda:"1",criterio:$("#txtSearch").val(),idempresa:$("#hdIdEmpresa").val(),idcentro:$("#hdIdCentro").val(),pagina:e},success:function(a){var o=a.length,n=0,i="";if(o>0){for(;n<o;){var r=a[n].tm_idregistrocompra,l=a[n].SimboloMoneda+" "+Number(a[n].tm_subtotal).toFixed(2),d=a[n].SimboloMoneda+" "+Number(a[n].tm_impuesto).toFixed(2),c=a[n].SimboloMoneda+" "+Number(a[n].tm_totalcompra).toFixed(2);i+="<div ",i+='data-id="'+r+'" ',i+='class="result item pos-rel animate mdl-shadow--2dp margin10">',i+='<div class="col-md-4">',i+="<h4>ID Compra #"+r+"</h4>",i+='<p class="lugar"><strong>Cod. compra: </strong>'+a[n].tm_serie_documento+"-"+a[n].tm_numero_documento+"</p>",i+='<p class="lugar"><strong>Tipo de comprobante: </strong>'+a[n].TipoComprobante+"</p>",i+='<p class="lugar"><strong>Fecha: </strong>'+ConvertMySQLDate(a[n].tm_fecha_recibo)+"</p>",i+="</div>",i+='<div class="col-md-4">',i+="<h4>Proveedor:</h4>",i+='<span class="duracion">'+a[n].Proveedor+"</span>",i+="</div>",i+='<div class="col-md-4">',i+='<h4 class="text-center">Monto de venta</h4>',i+='<h5 class="row"><strong class="col-md-4">Base imponible: </strong><span class="col-md-8 blue-text text-right">'+l+"</span></h5>",i+='<h5 class="row"><strong class="col-md-4">Impuestos deducidos: </strong><span class="col-md-8 blue-text text-right">'+d+"</span></h5>",i+='<h5 class="row"><strong class="col-md-4">Total de importe: </strong><span class="col-md-8 blue-text text-right">'+c+"</span></h5>",i+='<div class="clear"></div>',i+="</div>",i+="</div>",++n}gvDatos.currentPage(gvDatos.currentPage()+1),"1"==e?$(t).html(i):$(t).append(i),$(t+" .grouped-buttons a.tooltipped").tooltip()}else"1"==e&&$(t).html("<h2>No se encontraron resultados.</h2>");precargaExp("#pnlListado",!1)},error:function(e){console.log(e)}})}function habilitarModuloProveedor(e){"GET"==e?(habilitarControl("#txtSearchProveedor",!0),habilitarControl("#txtNroDocProveedor,#txtRazonSocialProveedor,#txtDireccionProveedor,#txtTelefonoProveedor,#txtEmailProveedor",!1)):(habilitarControl("#txtSearchProveedor",!1),habilitarControl("#txtNroDocProveedor,#txtRazonSocialProveedor,#txtDireccionProveedor,#txtTelefonoProveedor,#txtEmailProveedor",!0))}function AplicarTarjeta(){$("#lblTotalComision .monto").text(Number($("#txtComisionTarjeta").val()).toFixed(2)),closeCustomModal("#pnlInfoTarjeta")}function GetIdAperturaCaja(){var e=config.compras.id,t=window.top.document.querySelector('.mdl-card[data-id="'+e+'"]'),a=t.getAttribute("data-idcajareferer");$("#hdIdAperturaCaja").val(a)}$(function(){GetIdAperturaCaja(),BuscarDatos("1"),$("#btnBackCaja").on("click",function(e){e.preventDefault()}),$("#ddlTipoComprobante").on("change",function(e){e.preventDefault(),CalcularTotal()}),$("#chkImpuesto").on("change",function(e){e.preventDefault(),CalcularTotal()}),$("#gvInsumo tbody").on("scroll",function(e){gvInsumo.listenerScroll(this,e)}),$("#cantidad_custom0").on("keyup",function(e){var t=Number(this.value),a=Number(document.getElementById("precio_custom0").value),o=t*a;$("#subtotal_custom0").val(o.toFixed(2)).parent().find("h4").text(o.toFixed(2))}),$("#precio_custom0").on("keyup",function(e){var t=Number(document.getElementById("cantidad_custom0").value),a=Number(this.value),o=t*a;$("#subtotal_custom0").val(o.toFixed(2)).parent().find("h4").text(o.toFixed(2))}),$("#ddlNombreTarjeta").on("change",function(e){e.preventDefault(),ExtraerComisionTarjeta()}),$("#btnBackToList").on("click",function(e){e.preventDefault(),BackToList()}),$("#pnlProveedor").on("change",'input:radio[name="rbRegProveedor"]',function(e){habilitarModuloProveedor(this.value)}),$("#txtSearchProveedor").easyAutocomplete({url:function(e){var t="services/proveedores/proveedores-search.php";return t+="?idempresa="+$("#hdIdEmpresa").val(),t+="&idcentro="+$("#hdIdCentro").val(),t+="&tipobusqueda=3",t+="&criterio="+e},getValue:function(e){return e.tm_numerodoc.toLowerCase()+" - "+e.tm_nombreproveedor},list:{onSelectItemEvent:function(){var e=$("#txtSearchProveedor").getSelectedItemData().tm_idproveedor;$("#hdIdProveedor").val(e).trigger("change")}},template:{type:"custom",method:function(e,t){return t.tm_numerodoc.toLowerCase()+" - "+t.tm_nombreproveedor}},theme:"square"}),$("#btnAddProveedor").on("click",function(e){e.preventDefault(),seleccionarProveedor()}),$("#ddlMoneda").on("change",function(e){e.preventDefault(),ExtraerTipoCambio(),ExtraerSimboloMoneda()}),$("#btnEditTarjeta").on("click",function(e){e.preventDefault(),openModalCallBack("#pnlInfoTarjeta",function(){LimpiarTarjeta()})}),$("#ddlFormaPago").on("change",function(e){e.preventDefault();var t=$("#ddlFormaPago option:selected").attr("data-codigosunat");"005"==t?($("#btnEditTarjeta").removeClass("hide"),openModalCallBack("#pnlInfoTarjeta",function(){LimpiarTarjeta()})):$("#btnEditTarjeta").addClass("hide")}),$("#btnCloseInfoTarjeta").on("click",function(e){e.preventDefault(),LimpiarTarjeta(),closeCustomModal("#pnlInfoTarjeta"),$("#ddlFormaPago")[0].selectedIndex=$('#ddlFormaPago option[data-codigosunat="009"]').index()}),$("#btnLimpiarTarjeta").on("click",function(e){e.preventDefault(),LimpiarTarjeta()}),$("#btnAplicarTarjeta").on("click",function(e){e.preventDefault(),AplicarTarjeta()}),$("#btnNuevo").on("click",function(e){e.preventDefault(),mostrarAlmacen($("#chkIngresoAutomatico")[0].checked),Limpiar(),GoToEdit("0")}),$("#btnBuscarItems").on("click",function(e){e.preventDefault(),MostrarPanelItems()}),$("#btnBackToList_FromGuia").on("click",function(e){e.preventDefault(),$("#pnlGuia").fadeOut(400,function(){$("#pnlForm").fadeIn(400,function(){})})}),$("#pnlForm .title-window button").on("click",function(e){$(this).siblings(".success").removeClass("success"),$(this).addClass("success"),"01"==$(this).attr("data-tipocompra")&&($("#dateMenu").calendar({multiSelect:!0,getDates:function(e){},click:function(e){}}),openCustomModal("#pnlRequerimiento"))}),$("#tableDetalle tbody").on("click",'a[data-action="delete"]',function(e){e.preventDefault();var t=getParentsUntil(this,"#tableDetalle","tr");$(t[0]).remove(),CalcularTotal()}),$("#tableDetalle tbody").on("keyup",'input[type="number"]',function(e){var t=e.target,a=0,o=0,n=getParentsUntil(t,"#tableDetalle","tr");n=n[0],t.classList.contains("cantidad")?(o=t.value,a=n.getElementsByClassName("precio")[0].value):(o=n.getElementsByClassName("cantidad")[0].value,a=t.value);var i=o*a,r=n.getElementsByClassName("subtotal")[0];r.getElementsByTagName("input")[0].value=i.toFixed(2),r.getElementsByTagName("h4")[0].innerHTML=i.toFixed(2),CalcularTotal()}),$("#pnlInfoProveedor").on("click",function(e){e.preventDefault(),openCustomModal("#pnlProveedor")}),$("#txtSearchProd").keyup(function(e){AlternarBusquedaItems()}).keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER)return!1}),$("#btnGuardar").on("click",function(e){e.preventDefault(),Guardar()}),$(".date-register").datetimepicker({format:"DD/MM/YYYY"}),$("#btnSelectDetalleCompra").on("click",function(e){e.preventDefault(),openModalCallBack("#pnlProductos",function(){ListarInsumos("1")})}),$("#gvInsumo tbody").on("click","input:checkbox",function(e){var t=getParentsUntil(this,"#gvInsumo","tr"),a=t[0].getElementsByClassName("select-presentacion")[0],o=t[0].getElementsByClassName("cantidad")[0],n=t[0].getElementsByClassName("precio")[0],i=t[0].getElementsByClassName("subtotal")[0].getElementsByTagName("input")[0],r=t[0].getElementsByTagName("h4")[0];this.checked?(a.removeAttribute("disabled"),o.removeAttribute("disabled"),n.removeAttribute("disabled"),r.classList.remove("grey-text"),o.focus(),habilitarControl("#btnAddItemsCompra",!0)):(a.setAttribute("disabled",""),o.setAttribute("disabled",""),o.value="",n.value="",i.value="",n.setAttribute("disabled",""),r.classList.add("grey-text"),r.innerHTML="0.00",0==$("#gvInsumo input:checked").length&&habilitarControl("#btnAddItemsCompra",!1))}),$("#gvInsumo tbody").on("keyup",'input[type="number"]',function(e){var t=e.target,a=0,o=0,n=getParentsUntil(t,"#gvInsumo","tr");n=n[0],t.classList.contains("cantidad")?(o=t.value,a=n.getElementsByClassName("precio")[0].value):(o=n.getElementsByClassName("cantidad")[0].value,a=t.value);var i=o*a,r=n.getElementsByClassName("subtotal")[0];r.getElementsByTagName("input")[0].value=i.toFixed(2),r.getElementsByTagName("h4")[0].innerHTML=i.toFixed(2)}),$("#tabAddItemsCompra").on("click",".mdl-tabs__tab",function(e){var t=this,a=t.hash.substring(1),o=!1;"rogers-panel"==a?(o=!0,$(".mdl-textfield--expandable").addClass("hide")):($(".mdl-textfield--expandable").removeClass("hide"),o=!1,ListarInsumos("1")),habilitarControl("#btnAddItemsCompra",o)}),$("#btnAddItemsCompra").on("click",function(e){e.preventDefault(),AgregarItemsCompra()})});var gvDatos=new DataList("#gvDatos",{onSearch:function(){BuscarDatos(gvDatos.currentPage())}}),gvInsumo=new DataList("#gvInsumo",{onSearch:function(){ListarInsumos(gvInsumo.currentPage())}}),cuentafila=0;