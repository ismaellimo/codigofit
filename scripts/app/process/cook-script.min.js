function GuardarCambios(e){var t=new FormData,n=$("#hdIdAtencion").val(),a="01"==e?"#gvArticuloMenu_SinAtender":"#gvArticuloMenu_Atendidos";t.append("hdEstadoNuevo",e),t.append("hdTipoAccion",$("#hdTipoAccion").val()),t.append("hdIdAtencion",n);var i=$(a+" :input").serializeArray();Array.prototype.forEach.call(i,function(e){t.append(e.name,e.value)}),$.ajax({type:"POST",url:"services/atencion/despacho-post.php",cache:!1,contentType:!1,processData:!1,dataType:"json",data:t,success:function(e){if(createSnackbar(e.titulomsje),"0"!=e.rpta){var t=$('#gvOrdenes .dato[data-idorden="'+n+'"]'),a=getParentsUntil(t[0],"#gvOrdenes",".panel");console.log(t),console.log(a),t.find(".mdl-card__media").css("background-color",e.ColorEstado),listarDetalle("00",n),listarDetalle("01",n),"05"==e.EstadoAtencion&&(t.remove(),0==$("#gvOrdenes .dato").length&&$(a).remove())}},error:function(e){console.log(e)}})}function clearOneSelectedOrder(){$("#gvOrdenes .dato").removeClass("oneSelected")}function crearItems_Orden(e){var t="",n=0,a=0;if(a=1==e.length?"undefined"!=typeof e[0].tm_nroatencion&&0==e[0].tm_nroatencion.trim().length?0:1:e.length,a>0)for(;n<a;)"undefined"!=typeof e[n]&&(t='<div data-idorden="'+e[n].tm_idatencion+'" class="demo-card-order dato mdl-card mdl-cell mdl-cell--6-col mdl-shadow--2dp">',t+='<input type="checkbox" class="hide" value="'+e[n].tm_idatencion+'" />',t+='<div class="mdl-card__media pos-rel" style="min-height: 140px;">',t+='<h4 class="no-margin text-center block centered white-text" style="height: 30px; width: 100%;">',t+="<strong>ORDEN</strong>: "+e[n].tm_nroatencion,t+="</h4>",t+="</div>",t+='<div class="mdl-card__title">',t+='<h5 class="align-right">',t+='<span class="padding-right10 padding-left10 place-right"><strong>MOZO</strong>: Admin</span>',t+="</h5>",t+="</div>",t+='<div class="mark-selected pos-abs indigo accent-4 white-text circle"><i class="material-icons centered">&#xE5CA;</i></div>',t+='<i class="icon-select centered material-icons white-text circle">&#xE5CA;</i>',t+='<div class="layer-select"></div>',t+="</div>"),++n;return t}function crearItems_Mesa(e,t,n){var a="";return a+='<div class="panel panel-default mdl-cell mdl-cell--12-col" data-idmesa="'+e+'">',a+='<div class="panel-heading">',a+='<h3 class="panel-title">Mesa: '+t+"</h3>",a+="</div>",a+='<div class="panel-body flexibox-row">',a+=crearItems_Orden(n),a+="</div>",a+="</div>"}function atencion_Notif(){var e=new Comet("services/atencion/despacho-update.php",{idempresa:$("#hdIdEmpresa").val(),idcentro:$("#hdIdCentro").val(),estadoatencion:"03"},function(e){agregarDataNotificacion(e)});e.connect()}function ListarMesas(e){var t="undefined"==typeof e?"0":e;$.ajax({url:"services/atencion/atencion-search.php",type:"GET",dataType:"json",data:{tipobusqueda:"ATENCION-COOK",idempresa:$("#hdIdEmpresa").val(),idcentro:$("#hdIdCentro").val(),idambiente:"0",idmesas:"0",idatencion:t,estado:"03,04"},cache:!1,success:function(e){var n="",a=0,i=_.groupBy(e,function(e){return e.tm_idmesa+"#"+e.infomesa}),d=_.map(i,function(e){return{tm_idmesa:e[0].tm_idmesa,infomesa:e[0].infomesa,list_atencion:e}}),o=d.length;if(o>0)if("0"==t){for(;a<o;)n+=crearItems_Mesa(d[a].tm_idmesa,d[a].infomesa,d[a].list_atencion),++a;$("#gvOrdenes .gridview-content").html(n)}else{var c=$('#gvOrdenes .panel[data-idmesa="'+d[a].tm_idmesa+'"]');if(0==c.length)n=crearItems_Mesa(d[a].tm_idmesa,d[a].infomesa,d[a].list_atencion),$("#gvOrdenes .gridview-content").after(n);else{var r=$('#gvOrdenes .dato[data-idorden="'+d[a].list_atencion[0].tm_idatencion+'"]');0==r.length&&(n=crearItems_Orden(d[a].list_atencion),c.find(".panel-body").prepend(n))}}},error:function(e){console.log(e)}})}function listarDetalle(e,t){$.ajax({url:"services/atencion/detallearticulo-search.php",type:"GET",dataType:"json",data:{tipo:"3",idatencion:t,estado:e},success:function(t){var n="00"==e?"#gvArticuloMenu_SinAtender":"#gvArticuloMenu_Atendidos",a="",i=0,d=_.groupBy(t,function(e){return e.td_idatencion_articulo+"#"+e.idArticulo+"#"+e.nombreArticulo+"#"+e.td_precio+"#"+e.td_cantidad+"#"+e.td_subtotal+"#"+e.td_observacion+"#"+e.tm_foto}),o=_.map(d,function(e){return{td_idatencion_articulo:e[0].td_idatencion_articulo,idArticulo:e[0].idArticulo,nombreArticulo:e[0].nombreArticulo,td_precio:e[0].td_precio,td_cantidad:e[0].td_cantidad,td_subtotal:e[0].td_subtotal,td_observacion:e[0].td_observacion,tm_foto:e[0].tm_foto,list_articulo:e}}),c=o.length;if(c>0){for(;i<c;){var r=Number(o[i].td_cantidad).toFixed(0),l=Number(o[i].td_precio).toFixed(2),s=Number(o[i].td_subtotal);a+='<div class="demo-card-article margin10 mdl-card mdl-shadow--2dp">',a+='<div class="mdl-card__title mdl-card--expand no-padding pos-rel">',a+='<div class="mdl-grid mdl-grid--no-spacing full-size" style="height: 143px;">';var u=0,p=o[i].list_articulo;if(1==p.length&&0==p[0].nombreProducto.trim().length?count_detalle=0:count_detalle=p.length,count_detalle>0){for(a+='<div class="mdl-cell mdl-cell--8-col all-height"><div class="scrollbarra padding10">';u<count_detalle;)"undefined"!=typeof p[u]&&(a+='<div class="chip margin5">'+p[u].nombreProducto+"</div>"),++u;a+="</div>"}else a+='<div class="mdl-cell mdl-cell--8-col all-height demo-card-article__photo" style="background-image: url('+o[i].tm_foto.replace("_o","_s225")+');">';a+="</div>",a+='<div class="mdl-cell mdl-cell--4-col all-height">',a+='<div class="padding10 place-top-right indigo-text"><strong>'+o[i].nombreArticulo+"</strong></div>",a+='<div class="padding10 place-bottom-right">',a+='<p class="text-right"><input type="hidden" name="mc_articulo['+i+'][cantidad]" id="cantidad'+i+'" value="'+r+'"><strong>Cantidad: '+r+"</strong></p>",a+='<p class="text-right"><input type="hidden" name="mc_articulo['+i+'][precio]" id="precio'+i+'" value="'+l+'"><strong>Precio: '+l+"</strong></p>",a+="</div>",a+="</div></div>",a+="</div>",a+='<div class="mdl-card__actions mdl-card--border">',a+='<input type="checkbox" class="filled-in" name="chkItem[]" id="chkItem'+i+o[i].td_idatencion_articulo+'"  value="'+o[i].td_idatencion_articulo+'" /><label for="chkItem'+i+o[i].td_idatencion_articulo+'">SELECCIONAR</label>',a+='<div class="mdl-layout-spacer"></div>',a+='<p><strong class="text-right"><input type="hidden" name="mc_articulo['+i+'][subtotal]" id="subtotal'+i+'" value="'+s.toFixed(2)+'">Importe: S/. '+s.toFixed(2)+"</strong></p>",a+="</div>",a+="</div>",++i}"00"==e?$("#btnAtenderOrden").removeClass("hide"):$("#btnCompletarOrden").removeClass("hide")}$(n).html(a)},error:function(e){console.log(e)}})}$(function(){atencion_Notif(),ListarMesas(),$("#gvArticuloMenu_SinAtender").on("click","input:checkbox",function(e){this.checked?$("#btnAtenderSeleccion").removeClass("hide"):0==$("#gvArticuloMenu_SinAtender input:checkbox:checked").length&&$("#btnAtenderSeleccion").addClass("hide")}),$("#gvArticuloMenu_Atendidos").on("click","input:checkbox",function(e){this.checked?$("#btnCompletarSeleccion").removeClass("hide"):0==$("#gvArticuloMenu_Atendidos input:checkbox:checked").length&&$("#btnCompletarSeleccion").addClass("hide")}),$("#btnAtenderSeleccion").on("click",function(e){e.preventDefault(),$(this).addClass("hide"),$("#hdTipoAccion").val("SELECTION"),GuardarCambios("01")}),$("#btnCompletarSeleccion").on("click",function(e){e.preventDefault(),$(this).addClass("hide"),$("#btnAtenderSeleccion").addClass("hide"),$("#hdTipoAccion").val("SELECTION"),GuardarCambios("02")}),$("#btnAtenderOrden").on("click",function(e){e.preventDefault(),$(this).addClass("hide"),$("#hdTipoAccion").val("ALL"),GuardarCambios("01")}),$("#btnCompletarOrden").on("click",function(e){e.preventDefault(),$(this).addClass("hide"),$("#btnAtenderOrden").addClass("hide"),$("#hdTipoAccion").val("ALL"),GuardarCambios("02")})});var gvOrdenes=new DataList("#gvOrdenes",{onSearch:function(){},onInitSelecting:function(e){clearOneSelectedOrder()},onSelectClear:function(){$("#gvOrdenes .dato:first").addClass("oneSelected"),$("#btnConfirmOrder").addClass("hide")},oneItemClick:function(e){e.preventDefault(),e.stopPropagation(),clearOneSelectedOrder();var t=e.target,n=getParentsUntil(t,"#gvOrdenes",".dato");$(n).addClass("oneSelected");var a=n[0].getAttribute("data-idorden");$("#hdIdAtencion").val(a),$("#btnAtenderSeleccion, #btnCompletarSeleccion").addClass("hide"),$("#btnCompletarOrden").addClass("hide"),listarDetalle("00",a),listarDetalle("01",a)}}),progressError=!1,agregarDataNotificacion=function(e){if("undefined"!=typeof e.idatencion&&"0"!=e.idatencion){var t=e.idatencion,n=e.nroatencion;ListarMesas(t),playNotifSound(),showNotification("Orden N# "+n,"Esta orden requiere de su atenci√≥n!",{click:function(e){var t=config.despacho.id;window.top.document.querySelector('.mdl-card[data-id="'+t+'"]').trigger("click"),e.target.close()}})}};